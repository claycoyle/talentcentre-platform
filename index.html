<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Team Development Platform</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            color: #111827;
            line-height: 1.5;
        }
        .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .title { font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem; }
        .subtitle { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #e5e7eb; color: #111827; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        input, textarea, select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        textarea { resize: vertical; font-family: inherit; }
        label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: #374151; }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { justify-content: center; align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: #6b7280; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .rep-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: box-shadow 0.2s; }
        .rep-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .session { border-left: 4px solid #2563eb; padding-left: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem; margin-bottom: 1rem; background: #f9fafb; padding: 1rem; border-radius: 0.375rem; }
        .note-item { border-left: 4px solid #10b981; padding-left: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem; margin-bottom: 1rem; background: #f0fdf4; padding: 1rem; border-radius: 0.375rem; }
        .action-item { border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .action-item.completed { background: #f0fdf4; border-color: #10b981; }
        .action-item input[type="checkbox"] { width: 1.25rem; height: 1.25rem; cursor: pointer; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500; color: white; }
        .progress-bar { width: 100%; height: 0.75rem; background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 9999px; transition: width 0.3s; }
        .form-section { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .range-input { -webkit-appearance: none; width: 100%; height: 0.5rem; border-radius: 0.25rem; background: #e5e7eb; outline: none; }
        .range-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 50%; background: #2563eb; cursor: pointer; }
        .range-input::-moz-range-thumb { width: 1rem; height: 1rem; border-radius: 50%; background: #2563eb; cursor: pointer; border: none; }
        .back-btn { color: #2563eb; cursor: pointer; margin-bottom: 1rem; display: inline-block; }
        .back-btn:hover { text-decoration: underline; }
        .empty-state { text-align: center; padding: 2rem; color: #9ca3af; }
        .rep-response { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 0.75rem; margin-top: 0.5rem; border-radius: 0.375rem; }
        .scrollable-section { max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
        .scrollable-section::-webkit-scrollbar { width: 8px; }
        .scrollable-section::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrollable-section::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .scrollable-section::-webkit-scrollbar-thumb:hover { background: #555; }
        .assessment-row { padding: 0.5rem; border-radius: 0.25rem; transition: background-color 0.2s; cursor: pointer; }
        .assessment-row:hover { background-color: #f3f4f6; }
        .assessment-row.highlighted { background-color: #dbeafe; }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            <p>Loading...</p>
        </div>
    </div>

    <script>
        console.log('Script starting...');
        
        const storage = {
            async get(key) {
                const item = localStorage.getItem(key);
                return item ? { key, value: item } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            }
        };

        let state = {
            view: 'manager',
            selectedRep: null,
            showingManageReps: false,
            editingPlan: false,
            editingSession: false,
            editingMatrix: false,
            editingNote: false,
            editingRepResponse: null,
            newSession: { date: '', focus: '', outcomes: '', actionItems: '' },
            newNote: { content: '' },
            matrixInput: { role: 'manager', skill1: 3, skill2: 3, skill3: 3, will1: 3, will2: 3, will3: 3 },
            reps: [
                { id: 1, name: 'Sarah Johnson', devPlan: 'Focus on consultative selling and objection handling', sessions: [], matrixHistory: [], notes: [], actionItems: [] },
                { id: 2, name: 'Mike Chen', devPlan: 'Develop closing techniques and pipeline management', sessions: [], matrixHistory: [], notes: [], actionItems: [] },
                { id: 3, name: 'Alex Rodriguez', devPlan: 'Improve discovery questions and needs analysis', sessions: [], matrixHistory: [], notes: [], actionItems: [] },
                { id: 4, name: 'Emily Davis', devPlan: 'Build product expertise and technical knowledge', sessions: [], matrixHistory: [], notes: [], actionItems: [] }
            ]
        };

        async function loadData() {
            try {
                const result = await storage.get('sales-dev-data');
                if (result?.value) {
                    const data = JSON.parse(result.value);
                    state.reps = data.reps || state.reps;
                }
            } catch (error) {
                console.log('Using default data');
            }
            render();
        }

        function saveData() {
            try {
                storage.set('sales-dev-data', JSON.stringify({ reps: state.reps }));
            } catch (error) {
                console.error('Error saving:', error);
            }
        }

        function getQuadrant(skill, will) {
            if (skill >= 3.5 && will >= 3.5) return { name: 'Star Performer', color: '#10b981' };
            if (skill >= 3.5 && will < 3.5) return { name: 'Capable but Unmotivated', color: '#f59e0b' };
            if (skill < 3.5 && will >= 3.5) return { name: 'Motivated Learner', color: '#3b82f6' };
            return { name: 'Needs Development', color: '#ef4444' };
        }

        function createMatrixSVG(data, showNames = false) {
            if (!data || data.length === 0) {
                return '<p class="empty-state">No assessment data yet</p>';
            }
            
            const width = 500;
            const height = 400;
            const padding = 50;
            
            // Group data by person/rep
            const groupedData = {};
            data.forEach(point => {
                const key = point.name || 'unknown';
                if (!groupedData[key]) {
                    groupedData[key] = { manager: [], self: [] };
                }
                if (point.role === 'self') {
                    groupedData[key].self.push(point);
                } else {
                    groupedData[key].manager.push(point);
                }
            });
            
            let circles = '';
            let assessmentList = [];
            
            // Draw assessments for each person
            Object.entries(groupedData).forEach(([name, assessments]) => {
                // Draw last 5 self assessments (purple) with fading opacity
                const selfAssessments = assessments.self.slice(-5);
                selfAssessments.forEach((point, idx) => {
                    const x = padding + ((point.skill - 1) / 4) * (width - 2 * padding);
                    const y = height - padding - ((point.will - 1) / 4) * (height - 2 * padding);
                    const quad = getQuadrant(point.skill, point.will);
                    
                    // Opacity: oldest (0) = 0.2, newest (4) = 1.0
                    const opacity = 0.2 + (idx / (selfAssessments.length - 1 || 1)) * 0.8;
                    
                    const assessmentId = `assess-${point.date}-${point.role}-${name}`.replace(/\s/g, '-');
                    assessmentList.push({
                        id: assessmentId,
                        name: name,
                        date: point.date,
                        skill: point.skill,
                        will: point.will,
                        role: point.role,
                        color: '#9333ea',
                        opacity: opacity
                    });
                    
                    circles += `<circle cx="${x}" cy="${y}" r="8" fill="#9333ea" opacity="${opacity}" 
                                stroke="#9333ea" stroke-width="2" class="matrix-dot" data-id="${assessmentId}"
                                onmouseover="highlightAssessment('${assessmentId}')" 
                                onmouseout="unhighlightAssessment('${assessmentId}')">
                        <title>${point.name || ''} - Self Assessment
Date: ${point.date}
Skill: ${point.skill.toFixed(1)} | Will: ${point.will.toFixed(1)}
${quad.name}</title>
                    </circle>`;
                });
                
                // Draw last 5 manager assessments (blue) with fading opacity
                const managerAssessments = assessments.manager.slice(-5);
                managerAssessments.forEach((point, idx) => {
                    const x = padding + ((point.skill - 1) / 4) * (width - 2 * padding);
                    const y = height - padding - ((point.will - 1) / 4) * (height - 2 * padding);
                    const quad = getQuadrant(point.skill, point.will);
                    
                    // Opacity: oldest (0) = 0.2, newest (4) = 1.0
                    const opacity = 0.2 + (idx / (managerAssessments.length - 1 || 1)) * 0.8;
                    
                    const assessmentId = `assess-${point.date}-${point.role}-${name}`.replace(/\s/g, '-');
                    assessmentList.push({
                        id: assessmentId,
                        name: name,
                        date: point.date,
                        skill: point.skill,
                        will: point.will,
                        role: point.role,
                        color: '#2563eb',
                        opacity: opacity
                    });
                    
                    circles += `<circle cx="${x}" cy="${y}" r="8" fill="#2563eb" opacity="${opacity}" 
                                stroke="#2563eb" stroke-width="2" class="matrix-dot" data-id="${assessmentId}"
                                onmouseover="highlightAssessment('${assessmentId}')" 
                                onmouseout="unhighlightAssessment('${assessmentId}')">
                        <title>${point.name || ''} - Manager Assessment
Date: ${point.date}
Skill: ${point.skill.toFixed(1)} | Will: ${point.will.toFixed(1)}
${quad.name}</title>
                    </circle>`;
                });
                
                // Show name label if requested
                if (showNames && name) {
                    // Use the most recent assessment for positioning the name
                    const latestPoint = [...assessments.self, ...assessments.manager].sort((a, b) => 
                        new Date(b.date) - new Date(a.date)
                    )[0];
                    if (latestPoint) {
                        const x = padding + ((latestPoint.skill - 1) / 4) * (width - 2 * padding);
                        const y = height - padding - ((latestPoint.will - 1) / 4) * (height - 2 * padding);
                        circles += `<text x="${x}" y="${y - 12}" text-anchor="middle" font-size="10" fill="#333">${name}</text>`;
                    }
                }
            });

            // Sort assessments by date (newest first)
            assessmentList.sort((a, b) => new Date(b.date) - new Date(a.date));

            const svgContent = `
                <svg width="100%" height="400" viewBox="0 0 ${width} ${height}" style="max-width: 100%;">
                    <rect x="${padding}" y="${padding}" width="${width - 2*padding}" height="${height - 2*padding}" 
                          fill="none" stroke="#ccc" stroke-width="1"/>
                    <line x1="${padding + (width - 2*padding)/2}" y1="${padding}" 
                          x2="${padding + (width - 2*padding)/2}" y2="${height - padding}" 
                          stroke="#e5e5e5" stroke-width="1" stroke-dasharray="5,5"/>
                    <line x1="${padding}" y1="${padding + (height - 2*padding)/2}" 
                          x2="${width - padding}" y2="${padding + (height - 2*padding)/2}" 
                          stroke="#e5e5e5" stroke-width="1" stroke-dasharray="5,5"/>
                    ${circles}
                    <text x="${width/2}" y="${height - 10}" text-anchor="middle" font-weight="bold">Skill</text>
                    <text x="15" y="${height/2}" text-anchor="middle" font-weight="bold" transform="rotate(-90, 15, ${height/2})">Will</text>
                    <text x="${padding}" y="${height - padding + 20}" font-size="12">1</text>
                    <text x="${width - padding}" y="${height - padding + 20}" font-size="12">5</text>
                    <text x="${padding - 20}" y="${height - padding}" font-size="12">1</text>
                    <text x="${padding - 20}" y="${padding}" font-size="12">5</text>
                </svg>
            `;

            const listContent = assessmentList.length > 0 ? assessmentList.map(assess => `
                <div class="assessment-row" id="row-${assess.id}" 
                     onmouseover="highlightAssessment('${assess.id}')" 
                     onmouseout="unhighlightAssessment('${assess.id}')"
                     style="display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="width: 0.75rem; height: 0.75rem; background-color: ${assess.color}; 
                                border-radius: 50%; opacity: ${assess.opacity};"></div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-sm font-semibold">${assess.name}</span>
                            <span class="text-sm text-gray">${assess.date}</span>
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: #6b7280;">
                            <span>Skill: ${assess.skill.toFixed(1)}</span>
                            <span>Will: ${assess.will.toFixed(1)}</span>
                            <span>${assess.role === 'self' ? 'Self' : 'Manager'}</span>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="empty-state">No assessments</p>';

            return `
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 1rem;">
                    <div>${svgContent}</div>
                    <div>
                        <h4 class="font-semibold mb-2">Assessment History</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${listContent}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderManageReps() {
            const repsListHTML = state.reps.map(rep => `
                <div class="rep-card" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 class="font-semibold" style="font-size: 1.125rem;">${rep.name}</h4>
                        <p class="text-sm text-gray">${rep.sessions.length} sessions, ${rep.notes ? rep.notes.length : 0} notes</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="renameRep(${rep.id})" class="btn btn-secondary btn-small">Rename</button>
                        <button onclick="deleteRep(${rep.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Manage Team Members</h3>
                        <button onclick="addNewRep()" class="btn btn-success">+ Add Rep</button>
                    </div>
                    <div class="grid grid-2">
                        ${repsListHTML}
                    </div>
                </div>
            `;
        }

        function renderTeamOverview() {
            const repsHTML = state.reps.map(rep => {
                const latest = rep.matrixHistory[rep.matrixHistory.length - 1];
                const quad = latest ? getQuadrant(latest.skill, latest.will) : null;
                
                return `
                    <div class="rep-card" onclick="selectRep(${rep.id})">
                        <div class="flex flex-between mb-3">
                            <div>
                                <h4 class="font-semibold" style="font-size: 1.125rem;">${rep.name}</h4>
                                <p class="text-sm text-gray">${rep.sessions.length} coaching sessions</p>
                            </div>
                            ${quad ? `<span class="badge" style="background-color: ${quad.color}; height: fit-content;">
                                ${quad.name}
                            </span>` : ''}
                        </div>
                        ${latest ? `
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray">Skill:</span> <span class="font-semibold">${latest.skill.toFixed(1)}</span></div>
                                <div><span class="text-gray">Will:</span> <span class="font-semibold">${latest.will.toFixed(1)}</span></div>
                            </div>
                        ` : '<p class="text-sm text-gray">No assessments yet</p>'}
                    </div>
                `;
            }).join('');

            const allData = state.reps.flatMap(r => {
                const latest = r.matrixHistory[r.matrixHistory.length - 1];
                return latest ? [{ ...latest, name: r.name }] : [];
            });

            return `
                <div class="card">
                    <h3 class="subtitle">Team Skill/Will Matrix</h3>
                    ${createMatrixSVG(allData, true)}
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 1rem; height: 1rem; background-color: #10b981; border-radius: 0.25rem;"></div>
                            <span class="text-sm">Star Performer</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 1rem; height: 1rem; background-color: #f59e0b; border-radius: 0.25rem;"></div>
                            <span class="text-sm">Capable but Unmotivated</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 1rem; height: 1rem; background-color: #3b82f6; border-radius: 0.25rem;"></div>
                            <span class="text-sm">Motivated Learner</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 1rem; height: 1rem; background-color: #ef4444; border-radius: 0.25rem;"></div>
                            <span class="text-sm">Needs Development</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="subtitle">Team Overview</h3>
                    <div class="grid grid-2">
                        ${repsHTML}
                    </div>
                </div>
            `;
        }

        function renderRepDetail(rep) {
            const latestMatrix = rep.matrixHistory[rep.matrixHistory.length - 1];
            
            const sessionsHTML = rep.sessions.length === 0 
                ? '<p class="empty-state">No coaching sessions recorded yet</p>'
                : rep.sessions.slice().reverse().map(session => `
                    <div class="session">
                        <div class="flex flex-between mb-2">
                            <div>
                                <p class="font-semibold">${session.focus}</p>
                                <p class="text-sm text-gray">${session.date} ${session.createdBy ? `• Created by ${session.createdBy}` : ''}</p>
                            </div>
                            ${(state.view === 'manager' || (state.view === 'rep' && session.createdBy === 'Rep')) ? `
                                <button onclick="deleteSession(${rep.id}, ${session.id})" class="btn btn-danger btn-small">Delete</button>
                            ` : ''}
                        </div>
                        ${session.outcomes ? `
                            <div class="mb-2">
                                <p class="text-sm font-semibold">Outcomes:</p>
                                <p class="text-sm text-gray">${session.outcomes}</p>
                            </div>
                        ` : ''}
                        ${session.actionItems ? `
                            <div class="mb-2">
                                <p class="text-sm font-semibold">Action Items:</p>
                                <p class="text-sm text-gray">${session.actionItems}</p>
                            </div>
                        ` : ''}
                        ${session.repResponses && session.repResponses.length > 0 ? `
                            <div class="mb-2">
                                <p class="text-sm font-semibold mb-2">Rep Responses:</p>
                                ${session.repResponses.map(response => `
                                    <div class="rep-response mb-2">
                                        <div class="flex flex-between mb-1">
                                            <span class="text-sm font-semibold">${response.author}</span>
                                            <div class="flex gap-2" style="align-items: center;">
                                                <span class="text-sm text-gray">${response.date}</span>
                                                ${(state.view === 'manager' || state.view === 'rep') ? `
                                                    <button onclick="deleteResponse(${rep.id}, ${session.id}, ${response.id})" class="btn btn-danger btn-small" style="padding: 0.125rem 0.375rem;">×</button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <p class="text-sm">${response.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${state.view === 'rep' ? `
                            ${state.editingRepResponse === session.id ? `
                                <div class="mt-2">
                                    <textarea id="repResponseEdit" rows="3" placeholder="Add your response to this session..."></textarea>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="saveRepResponse(${rep.id}, ${session.id})" class="btn btn-success btn-small">Save Response</button>
                                        <button onclick="cancelRepResponse()" class="btn btn-secondary btn-small">Cancel</button>
                                    </div>
                                </div>
                            ` : `
                                <button onclick="editRepResponse(${session.id})" class="btn btn-secondary btn-small mt-2">Add Response</button>
                            `}
                        ` : ''}
                    </div>
                `).join('');

            const notesHTML = rep.notes && rep.notes.length > 0 ? rep.notes.slice().reverse().map(note => `
                <div class="note-item">
                    <div class="flex flex-between mb-2">
                        <p class="text-sm text-gray">${note.date}</p>
                        <div class="flex gap-2" style="align-items: center;">
                            <span class="text-sm font-semibold" style="color: #10b981;">${note.author}</span>
                            ${(state.view === 'manager' || state.view === 'rep') ? `
                                <button onclick="deleteNote(${rep.id}, ${note.id})" class="btn btn-danger btn-small" style="padding: 0.125rem 0.375rem;">×</button>
                            ` : ''}
                        </div>
                    </div>
                    <p class="text-sm">${note.content}</p>
                </div>
            `).join('') : '<p class="empty-state">No notes yet</p>';

            const actionItemsHTML = rep.actionItems && rep.actionItems.length > 0 ? rep.actionItems.map(item => `
                <div class="action-item ${item.completed ? 'completed' : ''}">
                    <input type="checkbox" ${item.completed ? 'checked' : ''} 
                           onchange="toggleActionItem(${rep.id}, ${item.id})">
                    <div style="flex: 1;">
                        <p class="text-sm ${item.completed ? 'text-gray' : ''}" style="${item.completed ? 'text-decoration: line-through;' : ''}">${item.text}</p>
                        ${item.dueDate ? `<p class="text-sm text-gray">Due: ${item.dueDate}</p>` : ''}
                    </div>
                    ${state.view === 'manager' ? `
                        <button onclick="deleteActionItem(${rep.id}, ${item.id})" class="btn btn-danger btn-small" style="padding: 0.25rem 0.5rem;">×</button>
                    ` : ''}
                </div>
            `).join('') : '<p class="empty-state">No action items yet</p>';

            return `
                ${state.view === 'manager' ? `<span class="back-btn" onclick="goBack()">← Back to Team Overview</span>` : ''}
                
                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Development Plan</h3>
                        ${state.view === 'manager' ? `
                            <button onclick="toggleEditPlan()" class="btn btn-secondary">
                                ${state.editingPlan ? 'Cancel' : 'Edit'}
                            </button>
                        ` : ''}
                    </div>
                    ${state.editingPlan && state.view === 'manager' ? `
                        <textarea id="planEdit" rows="4" class="mb-3">${rep.devPlan}</textarea>
                        <button onclick="savePlan(${rep.id})" class="btn btn-primary">Save Plan</button>
                    ` : `<p>${rep.devPlan}</p>`}
                </div>

                ${latestMatrix ? `
                    <div class="card">
                        <h3 class="subtitle">Current Status</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray mb-2">Skill Level</p>
                                <div class="flex gap-2" style="align-items: center;">
                                    <div class="progress-bar" style="flex: 1;">
                                        <div class="progress-fill" style="width: ${(latestMatrix.skill / 5) * 100}%; background: #2563eb;"></div>
                                    </div>
                                    <span class="font-semibold">${latestMatrix.skill.toFixed(1)}</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray mb-2">Will Level</p>
                                <div class="flex gap-2" style="align-items: center;">
                                    <div class="progress-bar" style="flex: 1;">
                                        <div class="progress-fill" style="width: ${(latestMatrix.will / 5) * 100}%; background: #16a34a;"></div>
                                    </div>
                                    <span class="font-semibold">${latestMatrix.will.toFixed(1)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3" style="background-color: ${getQuadrant(latestMatrix.skill, latestMatrix.will).color}20; border-radius: 0.375rem;">
                            <p class="font-semibold" style="color: ${getQuadrant(latestMatrix.skill, latestMatrix.will).color}">
                                ${getQuadrant(latestMatrix.skill, latestMatrix.will).name}
                            </p>
                        </div>
                    </div>
                ` : ''}

                <div class="card">
                    <h3 class="subtitle">${rep.name}'s Progress</h3>
                    ${createMatrixSVG(rep.matrixHistory)}
                </div>

                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Action Items (${rep.actionItems ? rep.actionItems.filter(i => !i.completed).length : 0} active)</h3>
                        ${state.view === 'manager' ? `
                            <button onclick="addActionItem(${rep.id})" class="btn btn-primary btn-small">+ Add Item</button>
                        ` : ''}
                    </div>
                    <div class="scrollable-section">
                        ${actionItemsHTML}
                    </div>
                </div>

                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Notes & Reflections</h3>
                        <button onclick="toggleEditNote()" class="btn btn-primary">
                            ${state.editingNote ? 'Cancel' : '+ Add Note'}
                        </button>
                    </div>

                    ${state.editingNote ? `
                        <div class="form-section">
                            <textarea id="noteContent" rows="4" placeholder="Share your thoughts, reflections, or updates...">${state.newNote.content}</textarea>
                            <button onclick="saveNote(${rep.id})" class="btn btn-success mt-2">Save Note</button>
                        </div>
                    ` : ''}

                    <div class="scrollable-section">
                        ${notesHTML}
                    </div>
                </div>

                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Coaching Sessions (${rep.sessions.length})</h3>
                        <button onclick="toggleEditSession()" class="btn btn-primary">
                            ${state.editingSession ? 'Cancel' : '+ Add Session'}
                        </button>
                    </div>

                    ${state.editingSession ? `
                        <div class="form-section">
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div>
                                    <label>Date</label>
                                    <input type="date" id="sessionDate" value="${state.newSession.date}">
                                </div>
                                <div>
                                    <label>Focus Area</label>
                                    <input type="text" id="sessionFocus" placeholder="e.g., Objection handling" value="${state.newSession.focus}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Key Outcomes</label>
                                <textarea id="sessionOutcomes" rows="2" placeholder="What was accomplished?">${state.newSession.outcomes}</textarea>
                            </div>
                            <div class="mb-3">
                                <label>Action Items</label>
                                <textarea id="sessionActions" rows="2" placeholder="Next steps">${state.newSession.actionItems}</textarea>
                            </div>
                            <button onclick="saveSession(${rep.id})" class="btn btn-success">Save Session</button>
                        </div>
                    ` : ''}

                    <div class="scrollable-section">
                        ${sessionsHTML}
                    </div>
                </div>

                <div class="card">
                    <div class="flex flex-between mb-4">
                        <h3 class="subtitle" style="margin: 0;">Skill/Will Assessment</h3>
                        ${state.view === 'rep' ? `
                            <button onclick="toggleEditMatrix()" class="btn btn-primary">
                                ${state.editingMatrix ? 'Cancel' : 'Complete Self-Assessment'}
                            </button>
                        ` : state.view === 'manager' ? `
                            <button onclick="toggleEditMatrix()" class="btn btn-primary">
                                ${state.editingMatrix ? 'Cancel' : 'New Assessment'}
                            </button>
                        ` : ''}
                    </div>

                    ${state.editingMatrix ? `
                        <div class="form-section">
                            <div class="mb-4">
                                <label>Assessment Type</label>
                                <select id="matrixRole">
                                    <option value="${state.view === 'rep' ? 'self' : 'manager'}" selected>
                                        ${state.view === 'rep' ? 'Self Assessment' : 'Manager Assessment'}
                                    </option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <p class="font-semibold mb-3">Skill Elements (1-5 scale)</p>
                                <div style="display: grid; gap: 1rem;">
                                    <div>
                                        <label>Product Knowledge</label>
                                        <input type="range" id="skill1" min="1" max="5" value="${state.matrixInput.skill1}" class="range-input" oninput="updateMatrixValue('skill1', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="skill1-value">${state.matrixInput.skill1}</span></span>
                                    </div>
                                    <div>
                                        <label>Sales Techniques</label>
                                        <input type="range" id="skill2" min="1" max="5" value="${state.matrixInput.skill2}" class="range-input" oninput="updateMatrixValue('skill2', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="skill2-value">${state.matrixInput.skill2}</span></span>
                                    </div>
                                    <div>
                                        <label>Communication Skills</label>
                                        <input type="range" id="skill3" min="1" max="5" value="${state.matrixInput.skill3}" class="range-input" oninput="updateMatrixValue('skill3', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="skill3-value">${state.matrixInput.skill3}</span></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <p class="font-semibold mb-3">Will Elements (1-5 scale)</p>
                                <div style="display: grid; gap: 1rem;">
                                    <div>
                                        <label>Motivation & Drive</label>
                                        <input type="range" id="will1" min="1" max="5" value="${state.matrixInput.will1}" class="range-input" oninput="updateMatrixValue('will1', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="will1-value">${state.matrixInput.will1}</span></span>
                                    </div>
                                    <div>
                                        <label>Resilience & Attitude</label>
                                        <input type="range" id="will2" min="1" max="5" value="${state.matrixInput.will2}" class="range-input" oninput="updateMatrixValue('will2', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="will2-value">${state.matrixInput.will2}</span></span>
                                    </div>
                                    <div>
                                        <label>Coachability</label>
                                        <input type="range" id="will3" min="1" max="5" value="${state.matrixInput.will3}" class="range-input" oninput="updateMatrixValue('will3', this.value)">
                                        <span class="text-sm text-gray">Score: <span id="will3-value">${state.matrixInput.will3}</span></span>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveMatrix(${rep.id})" class="btn btn-success" style="width: 100%; padding: 0.75rem;">
                                Save Assessment
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function render() {
            console.log('Rendering...');
            const root = document.getElementById('root');
            
            const repSelectHTML = state.view === 'rep' ? `
                <select onchange="changeRep(this.value)" style="max-width: 16rem;">
                    ${state.reps.map(rep => `
                        <option value="${rep.id}" ${state.selectedRep?.id === rep.id ? 'selected' : ''}>${rep.name}</option>
                    `).join('')}
                </select>
            ` : '';

            root.innerHTML = `
                <div class="container">
                    <div class="card">
                        <div class="flex flex-between" style="align-items: baseline;">
                            <h1 class="title">Sales Team Development Platform</h1>
                            <span class="text-sm text-gray">v0.20</span>
                        </div>
                        <div class="btn-group">
                            <button onclick="switchView('manager')" class="btn ${state.view === 'manager' ? 'btn-primary' : 'btn-secondary'}">
                                Manager View
                            </button>
                            <button onclick="switchView('rep')" class="btn ${state.view === 'rep' ? 'btn-primary' : 'btn-secondary'}">
                                Rep View
                            </button>
                            ${state.view === 'manager' ? `
                                <button onclick="showManageReps()" class="btn btn-secondary">
                                    Manage Reps
                                </button>
                            ` : ''}
                        </div>
                        ${repSelectHTML}
                    </div>

                    ${state.view === 'manager' && !state.selectedRep 
                        ? state.showingManageReps
                            ? renderManageReps()
                            : renderTeamOverview()
                        : state.selectedRep 
                            ? renderRepDetail(state.selectedRep)
                            : ''}
                </div>
            `;
        }

        // Event handlers
        function switchView(view) {
            state.view = view;
            state.selectedRep = view === 'rep' ? state.reps[0] : null;
            state.showingManageReps = false;
            state.editingPlan = false;
            state.editingSession = false;
            state.editingMatrix = false;
            state.editingNote = false;
            state.editingRepResponse = null;
            render();
        }

        function showManageReps() {
            state.showingManageReps = true;
            state.selectedRep = null;
            render();
        }

        function addNewRep() {
            const name = prompt('Enter the new rep\'s name:');
            if (!name || !name.trim()) return;

            const newRep = {
                id: Date.now(),
                name: name.trim(),
                devPlan: 'New development plan - to be updated',
                sessions: [],
                matrixHistory: [],
                notes: [],
                actionItems: []
            };

            state.reps = [...state.reps, newRep];
            saveData();
            render();
        }

        function deleteRep(repId) {
            const rep = state.reps.find(r => r.id === repId);
            if (!rep) return;

            if (!confirm(`Are you sure you want to delete ${rep.name}? This will permanently delete all their data including sessions, notes, and assessments.`)) return;

            state.reps = state.reps.filter(r => r.id !== repId);
            saveData();
            render();
        }

        function renameRep(repId) {
            const rep = state.reps.find(r => r.id === repId);
            if (!rep) return;

            const newName = prompt(`Enter new name for ${rep.name}:`, rep.name);
            if (!newName || !newName.trim() || newName.trim() === rep.name) return;

            state.reps = state.reps.map(r => 
                r.id === repId ? { ...r, name: newName.trim() } : r
            );
            saveData();
            render();
        }

        function selectRep(id) {
            state.selectedRep = state.reps.find(r => r.id === id);
            render();
        }

        function changeRep(id) {
            state.selectedRep = state.reps.find(r => r.id === parseInt(id));
            render();
        }

        function goBack() {
            state.selectedRep = null;
            render();
        }

        function toggleEditPlan() {
            state.editingPlan = !state.editingPlan;
            render();
        }

        function savePlan(repId) {
            const newPlan = document.getElementById('planEdit').value;
            state.reps = state.reps.map(r => r.id === repId ? { ...r, devPlan: newPlan } : r);
            
            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            state.editingPlan = false;
            saveData();
            render();
        }

        function toggleEditSession() {
            state.editingSession = !state.editingSession;
            if (!state.editingSession) {
                state.newSession = { date: '', focus: '', outcomes: '', actionItems: '' };
            }
            render();
        }

        function saveSession(repId) {
            const date = document.getElementById('sessionDate').value;
            const focus = document.getElementById('sessionFocus').value;
            const outcomes = document.getElementById('sessionOutcomes').value;
            const actionItems = document.getElementById('sessionActions').value;

            if (!date || !focus) {
                alert('Please fill in date and focus area');
                return;
            }

            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        sessions: [...r.sessions, { 
                            id: Date.now(), 
                            date, 
                            focus, 
                            outcomes, 
                            actionItems, 
                            repResponses: [],
                            createdBy: state.view === 'manager' ? 'Manager' : 'Rep'
                        }]
                    };
                }
                return r;
            });

            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }

            state.editingSession = false;
            state.newSession = { date: '', focus: '', outcomes: '', actionItems: '' };
            saveData();
            render();
        }

        function toggleEditMatrix() {
            state.editingMatrix = !state.editingMatrix;
            if (!state.editingMatrix) {
                state.matrixInput = { role: state.view === 'rep' ? 'self' : 'manager', skill1: 3, skill2: 3, skill3: 3, will1: 3, will2: 3, will3: 3 };
            } else {
                state.matrixInput.role = state.view === 'rep' ? 'self' : 'manager';
            }
            render();
        }

        function updateMatrixValue(key, value) {
            state.matrixInput[key] = value;
            document.getElementById(key + '-value').textContent = value;
        }

        function saveMatrix(repId) {
            const role = document.getElementById('matrixRole').value;
            const skill1 = parseInt(document.getElementById('skill1').value);
            const skill2 = parseInt(document.getElementById('skill2').value);
            const skill3 = parseInt(document.getElementById('skill3').value);
            const will1 = parseInt(document.getElementById('will1').value);
            const will2 = parseInt(document.getElementById('will2').value);
            const will3 = parseInt(document.getElementById('will3').value);

            const skillAvg = (skill1 + skill2 + skill3) / 3;
            const willAvg = (will1 + will2 + will3) / 3;

            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        matrixHistory: [...r.matrixHistory, {
                            date: new Date().toISOString().split('T')[0],
                            skill: skillAvg,
                            will: willAvg,
                            role,
                            details: { skill1, skill2, skill3, will1, will2, will3 }
                        }]
                    };
                }
                return r;
            });

            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }

            state.editingMatrix = false;
            state.matrixInput = { role: 'manager', skill1: 3, skill2: 3, skill3: 3, will1: 3, will2: 3, will3: 3 };
            saveData();
            render();
        }

        function toggleEditNote() {
            state.editingNote = !state.editingNote;
            if (!state.editingNote) {
                state.newNote = { content: '' };
            }
            render();
        }

        function saveNote(repId) {
            console.log('saveNote called for rep:', repId);
            const content = document.getElementById('noteContent').value;
            if (!content.trim()) {
                alert('Please enter a note');
                return;
            }

            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    const notes = r.notes || [];
                    return {
                        ...r,
                        notes: [...notes, {
                            id: Date.now(),
                            date: new Date().toISOString().split('T')[0],
                            content,
                            author: 'Rep'
                        }]
                    };
                }
                return r;
            });

            // Update selectedRep to point to the new object
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }

            console.log('State updated, notes:', state.reps.find(r => r.id === repId).notes);
            state.editingNote = false;
            state.newNote = { content: '' };
            saveData();
            console.log('About to render');
            render();
            console.log('Render complete');
        }

        function editRepResponse(sessionId) {
            state.editingRepResponse = sessionId;
            render();
        }

        function cancelRepResponse() {
            state.editingRepResponse = null;
            render();
        }

        function saveRepResponse(repId, sessionId) {
            const response = document.getElementById('repResponseEdit').value;
            if (!response.trim()) {
                alert('Please enter a response');
                return;
            }

            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        sessions: r.sessions.map(s => {
                            if (s.id === sessionId) {
                                const repResponses = s.repResponses || [];
                                return {
                                    ...s,
                                    repResponses: [...repResponses, {
                                        id: Date.now(),
                                        date: new Date().toISOString().split('T')[0],
                                        content: response,
                                        author: 'Rep'
                                    }]
                                };
                            }
                            return s;
                        })
                    };
                }
                return r;
            });

            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }

            state.editingRepResponse = null;
            saveData();
            render();
        }

        function addActionItem(repId) {
            const text = prompt('Enter action item:');
            const dueDate = prompt('Due date (YYYY-MM-DD, or leave blank):');
            
            if (text && text.trim()) {
                state.reps = state.reps.map(r => {
                    if (r.id === repId) {
                        const actionItems = r.actionItems || [];
                        return {
                            ...r,
                            actionItems: [...actionItems, {
                                id: Date.now(),
                                text: text.trim(),
                                dueDate: dueDate || null,
                                completed: false
                            }]
                        };
                    }
                    return r;
                });
                
                // Update selectedRep reference
                if (state.selectedRep && state.selectedRep.id === repId) {
                    state.selectedRep = state.reps.find(r => r.id === repId);
                }
                
                saveData();
                render();
            }
        }

        function toggleActionItem(repId, itemId) {
            console.log('toggleActionItem called');
            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        actionItems: r.actionItems.map(item =>
                            item.id === itemId ? { ...item, completed: !item.completed } : item
                        )
                    };
                }
                return r;
            });
            
            // Update selectedRep to point to the new object
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            saveData();
            console.log('About to render after toggle');
            render();
            console.log('Render complete after toggle');
        }

        function deleteSession(repId, sessionId) {
            if (!confirm('Are you sure you want to delete this coaching session?')) return;
            
            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        sessions: r.sessions.filter(s => s.id !== sessionId)
                    };
                }
                return r;
            });
            
            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            saveData();
            render();
        }

        function deleteNote(repId, noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;
            
            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        notes: r.notes.filter(n => n.id !== noteId)
                    };
                }
                return r;
            });
            
            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            saveData();
            render();
        }

        function deleteResponse(repId, sessionId, responseId) {
            if (!confirm('Are you sure you want to delete this response?')) return;
            
            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        sessions: r.sessions.map(s => {
                            if (s.id === sessionId) {
                                return {
                                    ...s,
                                    repResponses: s.repResponses.filter(resp => resp.id !== responseId)
                                };
                            }
                            return s;
                        })
                    };
                }
                return r;
            });
            
            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            saveData();
            render();
        }

        function deleteActionItem(repId, itemId) {
            if (!confirm('Are you sure you want to delete this action item?')) return;
            
            state.reps = state.reps.map(r => {
                if (r.id === repId) {
                    return {
                        ...r,
                        actionItems: r.actionItems.filter(item => item.id !== itemId)
                    };
                }
                return r;
            });
            
            // Update selectedRep reference
            if (state.selectedRep && state.selectedRep.id === repId) {
                state.selectedRep = state.reps.find(r => r.id === repId);
            }
            
            saveData();
            render();
        }

        console.log('Calling loadData...');
        loadData();
    </script>
</body>
</html>
